<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>شبیه‌ساز پیشرفته BFO — هم دسکتاپ و هم موبایل (تک‌فایل)</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#21a179;
    --muted:#9aa7b2;
    --panel:#071019;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,#071021 0%, #081826 60%);color:#e6f0f2;font-family: "Vazirmatn", Tahoma, Arial, sans-serif;
    -webkit-font-smoothing:antialiased;
  }
  header{padding:18px 16px;text-align:center}
  h1{margin:0;font-size:20px}
  main{display:flex;gap:16px;padding:12px;align-items:flex-start;justify-content:center}
  /* left: canvas, right: controls/log/tree */
  .left, .right{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.6)}
  .left{flex:1;min-width:300px;max-width:900px}
  .right{width:360px;min-width:260px}
  /* canvas container responsive */
  .canvasWrap{display:flex;flex-direction:column;gap:8px;align-items:center}
  canvas#sim{width:100%;height:auto;border-radius:10px;background:linear-gradient(180deg,#0c1a2b00, #071021);}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:var(--accent);border:none;color:#042; padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  label{font-size:13px;color:var(--muted)}
  input[type=range]{width:160px}
  .log{background:linear-gradient(180deg,#071019,#0b1220);border-radius:8px;padding:8px;height:220px;overflow:auto;font-family:monospace;font-size:13px;color:#cfece0}
  .stat{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .legend .item{display:flex;gap:8px;align-items:center}
  .sw{width:14px;height:14px;border-radius:50%}
  footer{color:var(--muted);text-align:center;padding:12px;font-size:13px}
  /* tree canvas */
  #tree {width:100%;height:360px;border-radius:8px;background:#071019;border:1px solid rgba(255,255,255,0.02);display:block}
  /* responsive */
  @media(max-width:980px){
    main{flex-direction:column;padding:8px}
    .right{width:100%}
  }
  /* small touches */
  .titleSmall{font-size:13px;color:var(--muted);margin-top:6px}
  .controlRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>شبیه‌ساز پیشرفته الگوریتم جستجوی باکتریایی (BFO)</h1>
  <div class="titleSmall">نمایش هم‌زمان ۵ باکتری — Chemotaxis → Reproduction → Elimination/Dispersal — واکنش‌گرا برای موبایل و دسکتاپ</div>
</header>

<main>
  <section class="left">
    <div class="canvasWrap">
      <canvas id="sim" width="1000" height="260"></canvas>
      <div style="width:100%;display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div class="controls">
          <button id="startBtn">▶ اجرا</button>
          <button id="pauseBtn" class="ghost" disabled>⏸ توقف</button>
          <button id="resetBtn" class="ghost">↺ بازنشانی</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label>سرعت</label>
          <input id="speedRange" type="range" min="0.2" max="2.0" step="0.1" value="1">
          <label id="speedLbl" class="titleSmall">معمولی</label>
        </div>
      </div>
      <div style="width:100%;display:flex;justify-content:space-between;margin-top:8px">
        <div style="display:flex;gap:10px;align-items:center">
          <label>تعداد باکتری</label>
          <input id="popSize" type="number" min="3" max="8" value="5" style="width:68px;padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.02);color:#dff">
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label>حداکثر نسل</label>
          <input id="maxGen" type="number" min="1" max="500" value="100" style="width:80px;padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.02);color:#dff">
        </div>
      </div>
    </div>
    <div class="titleSmall" style="margin-top:10px;color:var(--muted)">محور x: دامنه [0,6]، تابع هدف: f(x) = (x - 3)² — گام: 1 (اعداد صحیح)</div>
  </section>

  <aside class="right">
    <h3 style="margin:0 0 10px 0">وضعیت و تنظیمات</h3>
    <div class="stat">
      <div class="chip">جمعیت: <span id="popN">5</span></div>
      <div class="chip">نسل: <span id="genN">0</span></div>
      <div class="chip">مرحله: <span id="phase">آماده</span></div>
    </div>

    <div style="margin-top:12px">
      <div style="font-size:13px;color:var(--muted)">افکت مسیر (Trail) / رنگ‌های باکتری‌ها</div>
      <div class="legend" id="legend"></div>
    </div>

    <h3 style="margin-top:12px">لاگ مرحله‌ای</h3>
    <div class="log" id="log"></div>

    <h3 style="margin-top:12px">درخت جستجو (پس از پایان)</h3>
    <canvas id="tree" width="320" height="340"></canvas>

    <div style="margin-top:10px;font-size:12px;color:var(--muted)">
      <strong>توضیح:</strong> این یک شبیه‌ساز آموزشی است. منطق شبیه‌سازی مراحل اصلی BFO را نمایش می‌دهد اما برای اهداف آموزشی ساده‌شده است.
    </div>
  </aside>
</main>

<footer>
  دانشجو: جمال سامخانیان — درس: هوش مصنوعی — استاد: دکتر رویا نمیرانیان
</footer>

<script>
/* ===========================================================
   شبیه‌ساز پیشرفته BFO — تک‌فایل
   - نمایش هم‌زمان N باکتری (پیش‌فرض 5)
   - مراحل: Chemotaxis (با انیمیشن)، Reproduction، Elimination/Dispersal
   - ثبت تاریخچه هر نسل برای رسم درخت
   - کنترل سرعت، شروع/توقف/بازنشانی، لاگ فارسی
   - responsive: سازگار با موبایل و دسکتاپ
   =========================================================== */

/* ---------------- پارامترها (قابل تغییر) ---------------- */
const DOMAIN_MIN = 0;
const DOMAIN_MAX = 6;
const TARGET = 3;
const STEP = 1;              // اندازه گام
const REPRO_COUNT = 2;       // تعداد بهترین‌هایی که تکثیر می‌شوند
const ELIM_PROB = 0.45;      // احتمال پراکندگی هر باکتری
const DEFAULT_POP = 5;

/* ---------------- المان‌های صفحه ---------------- */
const sim = document.getElementById('sim');
const sctx = sim.getContext('2d');
const tree = document.getElementById('tree');
const tctx = tree.getContext('2d');
const logEl = document.getElementById('log');
const legendEl = document.getElementById('legend');
const popNEl = document.getElementById('popN');
const genNEl = document.getElementById('genN');
const phaseEl = document.getElementById('phase');

const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const speedRange = document.getElementById('speedRange');
const speedLbl = document.getElementById('speedLbl');
const popSizeInput = document.getElementById('popSize');
const maxGenInput = document.getElementById('maxGen');

let W = sim.width = Math.min(1000, Math.max(360, document.documentElement.clientWidth-80));
let H = sim.height = 260;
let treeW = tree.width = 320, treeH = tree.height = 340;

/* responsive on resize */
window.addEventListener('resize', ()=> {
  W = sim.width = Math.min(1000, Math.max(360, document.documentElement.clientWidth-80));
  H = sim.height = 260;
  drawSimulation();
});

/* ---------------- رنگ‌ها و helper ---------------- */
const COLORS = ['#1f77b4','#ff7f0e','#2ca02c','#9467bd','#d62728','#8c564b','#e377c2','#7f7f7f'];
function col(i){ return COLORS[i % COLORS.length]; }
function rgba(hex, a=1){
  // simple conversion #rrggbb to rgba
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ---------------- ساختار داده باکتری ---------------- */
class Bacterium {
  constructor(id, x){
    this.id = id;
    this.x = x;       // موقعیت فعلی (صحیح)
    this.path = [x];  // مسیر تاریخی برای trail و درخت
  }
  fitness(){ return (this.x - TARGET) ** 2; }
  // chemotaxis: یک گام امتحانی (چپ/راست) و حرکت در صورت بهبود
  attemptStep(){
    const cur = this.fitness();
    const left = Math.max(DOMAIN_MIN, this.x - STEP);
    const right = Math.min(DOMAIN_MAX, this.x + STEP);
    const lf = (left - TARGET) ** 2;
    const rf = (right - TARGET) ** 2;
    // اگر هیچکدام بهبود نداد، برنمی‌دارد
    if(lf >= cur && rf >= cur) return false;
    // انتخاب جهت بهینه‌تر (در صورت مساوی سمت چپ را انتخاب کن)
    if(lf < cur && lf <= rf){ this.x = left; this.path.push(this.x); return true; }
    if(rf < cur && rf < lf){ this.x = right; this.path.push(this.x); return true; }
    return false;
  }
}

/* ---------------- حالت شبیه‌سازی ---------------- */
let population = [];
let history = []; // history[gen] = array of positions
let gen = 0;
let running = false;
let paused = false;

/* ---------------- مقداردهی اولیه ---------------- */
function init(popN = DEFAULT_POP){
  population = [];
  // توزیع اولیه: از 0,1,2,... تا
  for(let i=0;i<popN;i++){
    const pos = Math.min(DOMAIN_MAX, i); // predictable starter
    population.push(new Bacterium(i+1, pos));
  }
  history = [];
  gen = 0;
  updateUI();
  logClear();
  log(`جمعیت اولیه: ${population.map(b=>b.x).join(', ')}`);
  pushHistory();
  drawSimulation();
  renderLegend();
}

/* ذخیره تاریخچه */
function pushHistory(){ history.push(population.map(b=>b.x)); }

/* ---------------- لاگ و UI ---------------- */
function log(msg){
  const time = new Date().toLocaleTimeString();
  logEl.innerHTML += `[${time}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}
function logClear(){ logEl.innerHTML = ''; }
function updateUI(){ popNEl.textContent = population.length; genNEl.textContent = gen; }

/* ---------------- رسم شبیه‌سازی ---------------- */
function drawSimulation(){
  sctx.clearRect(0,0,W,H);
  const margin = 36;
  const lineY = H/2;
  // background subtle
  sctx.fillStyle = 'rgba(255,255,255,0.02)';
  sctx.fillRect(0,0,W,H);
  // axis line
  sctx.beginPath(); sctx.moveTo(margin,lineY); sctx.lineTo(W-margin,lineY);
  sctx.strokeStyle = '#274056'; sctx.lineWidth = 2; sctx.stroke();
  // ticks
  const domainLen = DOMAIN_MAX - DOMAIN_MIN;
  for(let v=DOMAIN_MIN; v<=DOMAIN_MAX; v++){
    const x = margin + (v - DOMAIN_MIN)/domainLen * (W - 2*margin);
    sctx.beginPath(); sctx.moveTo(x,lineY-8); sctx.lineTo(x,lineY+8);
    sctx.strokeStyle = '#0f2a38'; sctx.lineWidth = 1; sctx.stroke();
    sctx.fillStyle = '#9fb7c2'; sctx.font = '12px Tahoma'; sctx.fillText(String(v), x-6, lineY+26);
  }
  // target marker
  const tx = margin + (TARGET - DOMAIN_MIN)/domainLen * (W-2*margin);
  sctx.fillStyle = 'rgba(34,197,94,0.95)'; sctx.beginPath(); sctx.arc(tx, lineY-30, 10,0,Math.PI*2); sctx.fill();
  sctx.fillStyle = '#dfffe8'; sctx.font = '12px Tahoma'; sctx.fillText('هدف ۳', tx-14, lineY-40);

  // trails
  for(let i=0;i<population.length;i++){
    const b = population[i];
    const pts = b.path;
    sctx.beginPath();
    for(let k=0;k<pts.length;k++){
      const x = margin + (pts[k]-DOMAIN_MIN)/domainLen * (W-2*margin);
      const y = lineY - 28 + (i%3)*10; // vertical offset small
      if(k===0) sctx.moveTo(x,y); else sctx.lineTo(x,y);
    }
    sctx.strokeStyle = rgba(col(i), 0.7);
    sctx.lineWidth = 3; sctx.stroke();
  }
  // draw bacteria
  for(let i=0;i<population.length;i++){
    const b = population[i];
    const x = margin + (b.x - DOMAIN_MIN)/domainLen * (W-2*margin);
    const y = lineY;
    // shadow
    sctx.beginPath(); sctx.fillStyle = 'rgba(0,0,0,0.18)'; sctx.ellipse(x+4,y+6,14,7,0,0,Math.PI*2); sctx.fill();
    sctx.beginPath(); sctx.fillStyle = col(i); sctx.arc(x,y,14,0,Math.PI*2); sctx.fill();
    sctx.strokeStyle = '#071118'; sctx.lineWidth = 1; sctx.stroke();
    sctx.fillStyle = '#fff'; sctx.font='12px Tahoma'; sctx.fillText('B'+b.id, x-10, y+5);
  }
}

/* ---------------- انیمیشن گام به گام Chemotaxis ----------------
   ایده: برای هر باکتری مسیر محلی (local run) محاسبه می‌شود (تعداد قدم‌ها).
   سپس این قدم‌ها به صورت همزمان با انیمیشن جلو می‌آیند (هر فریم هر باکتری یک قدم بردارد اگر داشته باشد).
*/
async function chemotaxisAnimated(speedFactor=1){
  phaseEl.textContent = 'Chemotaxis';
  log(`\n--- Chemotaxis نسل ${gen+1} ---`);
  // برای هر باکتری، مسیر محلی تا توقف را محاسبه کن (اما فعلاً اعمال نکن)
  const localPaths = population.map(b=>{
    const tempX = b.x;
    const tempPath = [];
    // clone position for simulation local
    let cur = b.x;
    while(true){
      const curFit = (cur - TARGET)**2;
      const left = Math.max(DOMAIN_MIN, cur - STEP);
      const right = Math.min(DOMAIN_MAX, cur + STEP);
      const lf = (left - TARGET)**2;
      const rf = (right - TARGET)**2;
      if(lf >= curFit && rf >= curFit) break;
      if(lf < curFit && lf <= rf){ cur = left; tempPath.push(cur); }
      else if(rf < curFit && rf < lf){ cur = right; tempPath.push(cur); }
      if(tempPath.length>20) break;
    }
    return tempPath;
  });

  // مرحله‌ای انیمیت می‌کنیم؛ بیشترین طول مسیر را در نظر می‌گیریم
  const maxSteps = Math.max(...localPaths.map(p=>p.length),0);
  for(let stepI=0; stepI<maxSteps; stepI++){
    // برای هر باکتری اگر هنوز پله دارد، موقعیت را آپدیت کن
    for(let i=0;i<population.length;i++){
      const p = localPaths[i];
      if(stepI < p.length){
        population[i].x = p[stepI];
        population[i].path.push(p[stepI]);
      }
    }
    drawSimulation();
    await sleep(220 / speedFactor); // کنترل سرعت انیمیشن
    if(!running) return;
  }
  log(`جمعیت بعد از Chemotaxis: ${population.map(b=>b.x).join(', ')}`);
  pushHistory();
}

/* ---------------- Reproduction ----------------
   - مرتب‌سازی بر اساس fitness (کوچک‌تر بهتر)
   - بهترین REPRO_COUNT کلون می‌شوند و جایگزین ضعیف‌ترین‌ها می‌شوند
*/
function reproduction(){
  phaseEl.textContent = 'Reproduction';
  log(`\n--- Reproduction نسل ${gen+1} ---`);
  // clone sorted refs
  const sorted = [...population].sort((a,b)=>a.fitness()-b.fitness());
  log(`fitness (از بهتر به ضعیف): ${sorted.map(b=>b.fitness()).join(', ')}`);
  // جایگزینی ضعیف‌ها
  for(let i=0;i<REPRO_COUNT;i++){
    const best = sorted[i];
    const worst = sorted[sorted.length-1-i];
    worst.x = best.x;
    worst.path.push(worst.x); // ثبت حرکت
    log(`باکتری ${worst.id} با کپی از باکتری ${best.id} جایگزین شد → ${best.x}`);
  }
  pushHistory();
}

/* ---------------- Elimination/Dispersal ----------------
   با احتمال ELIM_PROB هر باکتری به موقعیت تصادفی در دامنه منتقل می‌شود.
*/
function elimination(){
  phaseEl.textContent = 'Elimination/Dispersal';
  log(`\n--- Elimination/Dispersal نسل ${gen+1} ---`);
  for(const b of population){
    if(Math.random() < ELIM_PROB){
      const newPos = Math.floor(Math.random()*(DOMAIN_MAX - DOMAIN_MIN + 1)) + DOMAIN_MIN;
      b.x = newPos;
      b.path.push(b.x);
      log(`باکتری ${b.id} پراکنده شد → ${b.x}`);
    }
  }
  pushHistory();
}

/* ---------------- بررسی همگرایی ----------------
   شرط: همه باکتری‌ها دقیقا در TARGET باشند
*/
function checkConverged(){
  return population.every(b => b.x === TARGET);
}

/* ---------------- حلقه نسل‌ها ---------------- */
async function runAll(){
  if(running) return;
  running = true; paused = false;
  startBtn.disabled = true; pauseBtn.disabled = false;
  popSizeInput.disabled = true; maxGenInput.disabled = true;
  const speedFactor = parseFloat(speedRange.value); // 0.2..2.0
  const maxGen = parseInt(maxGenInput.value,10) || 100;

  while(running && gen < maxGen){
    gen++;
    genNEl.textContent = gen;
    // Chemotaxis
    await chemotaxisAnimated(speedFactor);
    if(!running) break;
    // Reproduction
    reproduction();
    drawSimulation();
    await sleep(450 / speedFactor);
    if(!running) break;
    // Elimination
    elimination();
    drawSimulation();
    await sleep(450 / speedFactor);
    if(checkConverged()){
      log('\n== همه باکتری‌ها به کمینه سراسری رسیدند! ==');
      break;
    }
  }

  running = false;
  startBtn.disabled = false; pauseBtn.disabled = true;
  popSizeInput.disabled = false; maxGenInput.disabled = false;
  phaseEl.textContent = 'پایان';
  drawTree();
}

/* ---------------- رسم درخت جستجو ----------------
   تاریخچه history: آرایه‌ای از آرایه‌ها (هر نسل)
   نمایش: ستون‌ها = نسل‌ها، ردیف‌ها = باکتری‌ها (index ثابت)
*/
function drawTree(){
  tctx.clearRect(0,0,treeW,treeH);
  if(history.length===0) return;
  const cols = history.length;
  const rows = population.length;
  const pad = 24;
  const cellW = (treeW - pad*2) / Math.max(1, cols-1);
  const cellH = (treeH - pad*2) / rows;
  tctx.font = '12px Tahoma';
  tctx.fillStyle = '#b8e6d6';
  tctx.fillText('درخت مسیر (هر گره = موقعیت x)', pad, 14);
  // گره‌ها
  for(let g=0; g<cols; g++){
    const genState = history[g];
    for(let r=0;r<rows;r++){
      const x = pad + g * cellW;
      const y = pad + r * cellH + cellH/2;
      // گره دایره‌ای با رنگ باکتری
      tctx.beginPath();
      tctx.fillStyle = col(r);
      tctx.arc(x, y, 10, 0, Math.PI*2);
      tctx.fill();
      // متن مقدار موقعیت
      tctx.fillStyle = '#071019';
      tctx.fillText(String(genState[r]), x-6, y+4);
      // اتصال به نسل قبلی همان ردیف
      if(g>0){
        const px = pad + (g-1)*cellW;
        const py = pad + r*cellH + cellH/2;
        tctx.beginPath();
        tctx.moveTo(px,py);
        tctx.lineTo(x,y);
        tctx.strokeStyle = 'rgba(180,180,180,0.18)';
        tctx.lineWidth = 1;
        tctx.stroke();
      }
      // اگر ستون اول، نشانگر ID
      if(g===0){
        tctx.fillStyle = '#9fb7c2';
        tctx.fillText('B'+population[r].id, 4, y+4);
      }
    }
  }
}

/* ---------------- legend rendering ---------------- */
function renderLegend(){
  legendEl.innerHTML = '';
  for(let i=0;i<population.length;i++){
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="sw" style="background:${col(i)}"></div><div style="font-size:13px">${'B'+population[i].id} — x=${population[i].x}</div>`;
    legendEl.appendChild(el);
  }
}

/* ---------------- کنترل‌ها ---------------- */
startBtn.addEventListener('click', ()=>{
  // init with specified pop size if not running
  const n = Math.max(3, Math.min(8, parseInt(popSizeInput.value,10) || DEFAULT_POP));
  if(!running){
    init(n);
    runAll().catch(err=>console.error(err));
  } else if(paused){
    // resume
    paused = false;
    runAll();
  }
});

pauseBtn.addEventListener('click', ()=>{
  if(!running) return;
  paused = !paused;
  if(paused){
    running = false;
    pauseBtn.textContent = '▶ ادامه';
    phaseEl.textContent = 'متوقف';
  } else {
    pauseBtn.textContent = '⏸ توقف';
    runAll();
  }
});

resetBtn.addEventListener('click', ()=>{
  running = false; paused = false;
  startBtn.disabled = false; pauseBtn.disabled = true;
  init(parseInt(popSizeInput.value,10) || DEFAULT_POP);
  tctx.clearRect(0,0,treeW,treeH);
  phaseEl.textContent = 'آماده';
});

/* speed label update */
speedRange.addEventListener('input', ()=>{
  const v = parseFloat(speedRange.value);
  if(v < 0.6) speedLbl.textContent = 'خیلی آهسته';
  else if(v < 1) speedLbl.textContent = 'آهسته';
  else if(v === 1) speedLbl.textContent = 'معمولی';
  else if(v < 1.5) speedLbl.textContent = 'سریع';
  else speedLbl.textContent = 'خیلی سریع';
});

/* ---------------- حفاظت و شروع اولیه ---------------- */
(function boot(){
  init(DEFAULT_POP);
  renderLegend();
  drawSimulation();
  pauseBtn.disabled = true;
})();
</script>
</body>
</html>
